<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PugSharky Broadcast</title>
    <script>
        async function loadApp() {
            const res = await fetch('/config');
            const config = await res.json();

            // Set page title
            document.title = config.page_title || 'Default Title';

            // Determine assets base URL
            const assetsUrl = config.primary
                ? '/assets'
                : (config.primary_url ? config.primary_url + '/assets' : '/assets');

            // Set favicon
            let faviconLink = document.querySelector('link[rel="icon"]');
            if (!faviconLink) {
                faviconLink = document.createElement('link');
                faviconLink.rel = 'icon';
                document.head.appendChild(faviconLink);
            }
            faviconLink.href = assetsUrl + '/favicon.ico';

            // Insert NavBar
            const nav = document.createElement('nav');

            const logo = document.createElement('img');
            logo.src = assetsUrl + '/favicon.ico';
            logo.alt = 'Logo';
            logo.style.height = '40px';
            logo.style.marginRight = '15px';
            nav.appendChild(logo);

            const title = document.createElement('span');
            title.textContent = config.website_name || 'My Website';

            nav.appendChild(title);
            // Create select dropdown for other instances
            const instanceSelect = document.createElement('select');
            instanceSelect.style.padding = '6px 10px';
            instanceSelect.style.fontSize = '1em';
            instanceSelect.style.borderRadius = '4px';
            instanceSelect.style.border = 'none';
            instanceSelect.style.cursor = 'pointer';
            instanceSelect.style.backgroundColor = '#444';
            instanceSelect.style.color = '#fff';
            instanceSelect.style.margin = 'auto 2vw auto'

            // Default option
            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'Switch broadcast';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            instanceSelect.appendChild(defaultOption);

            // Populate select from config.instances
            if (Array.isArray(config.instances)) {
                config.instances.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.base_path;
                    option.textContent = inst.name;
                    if (inst.base_path === config.base_path) option.selected = true; // current instance selected
                    instanceSelect.appendChild(option);
                });
            }

            // Navigate on select change
            instanceSelect.addEventListener('change', e => {
                window.location.href = e.target.value;
            });

            nav.appendChild(instanceSelect);

            document.body.insertBefore(nav, document.body.firstChild);

            //Dynamically load shared CSS from assets (shared for all instances)
            const sharedCssLink = document.createElement('link');
            sharedCssLink.rel = 'stylesheet';
            sharedCssLink.href = assetsUrl + '/style.css';  // <-- shared CSS in assets
            document.head.appendChild(sharedCssLink);

            //Dynamically load main.js from instance base path
            if (config.base_path) {
                const script = document.createElement('script');
                script.src = config.base_path + '/main.js';
                document.body.appendChild(script);
            }

            window.appConfig = config;
        }

        loadApp();
    </script>
</head>
<body>
  <div class="container">
    <div class="main">
      <!-- Twitch video embed (channel set dynamically via JS) -->
      <iframe id="twitch-player" allowfullscreen></iframe>

      <div class="scoreboard" id="scoreboard">
        <div id="team1"></div>
        <div id="score"></div>
        <div id="team2"></div>
      </div>

      <div class="players" id="players">
        <!-- Player cards inserted dynamically -->
      </div>
    </div>

    <!-- Twitch chat (channel set dynamically via JS) -->
    <iframe class="chat" id="twitch-chat"></iframe>
  </div>

</body>
</html>
